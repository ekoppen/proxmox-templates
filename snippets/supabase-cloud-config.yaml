#cloud-config

# ============================================
# SUPABASE CLOUD-INIT CONFIG
# Self-hosted Supabase met Docker
# PostgreSQL + GoTrue Auth + PostgREST + Studio
#
# Secrets worden on-VM gegenereerd (veilig!)
# Studio: http://<IP>:3000
# API:    http://<IP>:8000
# ============================================

package_update: true
package_upgrade: true

packages:
  - qemu-guest-agent
  - net-tools
  - curl
  - wget
  - vim
  - sudo
  - openssh-server
  - htop
  - unattended-upgrades
  - ca-certificates
  - gnupg
  - lsb-release
  - git
  - jq

ssh_pwauth: false

users:
  - name: admin
    groups: sudo, adm, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: true
    ssh_authorized_keys:
      - YOUR_SSH_PUBLIC_KEY_HERE

write_files:
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "storage-driver": "overlay2"
      }
  - path: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
  - path: /opt/supabase/generate-env.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      # Genereer Supabase .env op basis van .env.example met unieke secrets
      set -e

      cd /opt/supabase/docker
      ENV_FILE="/opt/supabase/docker/.env"

      # Start met het officiÃ«le .env.example als basis
      cp .env.example "$ENV_FILE"

      # Genereer unieke secrets
      JWT_SECRET=$(openssl rand -base64 40 | tr -d '/+\n' | head -c 40)
      POSTGRES_PASSWORD=$(openssl rand -base64 24 | tr -d '/+\n' | head -c 24)
      DASHBOARD_PASSWORD=$(openssl rand -base64 16 | tr -d '/+\n' | head -c 16)
      SECRET_KEY_BASE=$(openssl rand -hex 32)
      VAULT_ENC_KEY=$(openssl rand -hex 16)
      PG_META_CRYPTO_KEY=$(openssl rand -hex 16)
      LOGFLARE_API_KEY=$(openssl rand -hex 16)

      # Base64url encode helper
      b64url() { openssl enc -base64 -A | tr '+/' '-_' | tr -d '='; }

      # JWT token generatie
      gen_jwt() {
        local role="$1"
        local iat=$(date +%s)
        local exp=$((iat + 157680000))
        local header=$(echo -n '{"alg":"HS256","typ":"JWT"}' | b64url)
        local payload=$(echo -n "{\"role\":\"${role}\",\"iss\":\"supabase\",\"iat\":${iat},\"exp\":${exp}}" | b64url)
        local sig=$(echo -n "${header}.${payload}" | openssl dgst -sha256 -hmac "$JWT_SECRET" -binary | b64url)
        echo "${header}.${payload}.${sig}"
      }

      ANON_KEY=$(gen_jwt "anon")
      SERVICE_ROLE_KEY=$(gen_jwt "service_role")

      # Vervang secrets in .env (gekopieerd van .env.example)
      sed -i "s|^POSTGRES_PASSWORD=.*|POSTGRES_PASSWORD=${POSTGRES_PASSWORD}|" "$ENV_FILE"
      sed -i "s|^JWT_SECRET=.*|JWT_SECRET=${JWT_SECRET}|" "$ENV_FILE"
      sed -i "s|^ANON_KEY=.*|ANON_KEY=${ANON_KEY}|" "$ENV_FILE"
      sed -i "s|^SERVICE_ROLE_KEY=.*|SERVICE_ROLE_KEY=${SERVICE_ROLE_KEY}|" "$ENV_FILE"
      sed -i "s|^DASHBOARD_USERNAME=.*|DASHBOARD_USERNAME=admin|" "$ENV_FILE"
      sed -i "s|^DASHBOARD_PASSWORD=.*|DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD}|" "$ENV_FILE"
      sed -i "s|^SECRET_KEY_BASE=.*|SECRET_KEY_BASE=${SECRET_KEY_BASE}|" "$ENV_FILE"
      sed -i "s|^VAULT_ENC_KEY=.*|VAULT_ENC_KEY=${VAULT_ENC_KEY}|" "$ENV_FILE"
      sed -i "s|^PG_META_CRYPTO_KEY=.*|PG_META_CRYPTO_KEY=${PG_META_CRYPTO_KEY}|" "$ENV_FILE"
      sed -i "s|^LOGFLARE_API_KEY=.*|LOGFLARE_API_KEY=${LOGFLARE_API_KEY}|" "$ENV_FILE"

      # Stel DOCKER_SOCKET_LOCATION in als die ontbreekt of leeg is
      if ! grep -q "^DOCKER_SOCKET_LOCATION=" "$ENV_FILE"; then
        echo "DOCKER_SOCKET_LOCATION=/var/run/docker.sock" >> "$ENV_FILE"
      else
        sed -i "s|^DOCKER_SOCKET_LOCATION=.*|DOCKER_SOCKET_LOCATION=/var/run/docker.sock|" "$ENV_FILE"
      fi

      echo "Supabase .env gegenereerd met unieke secrets"
      echo "Dashboard wachtwoord: ${DASHBOARD_PASSWORD}"
      echo "Bewaar dit wachtwoord veilig!"

runcmd:
  # Basis services
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - systemctl enable ssh
  - systemctl start ssh

  # Docker installatie
  - curl -fsSL https://get.docker.com | sh
  - apt-get install -y docker-compose-plugin
  - usermod -aG docker admin

  # Supabase setup
  - mkdir -p /opt/supabase
  - git clone --depth 1 https://github.com/supabase/supabase /opt/supabase/repo
  - cp -r /opt/supabase/repo/docker /opt/supabase/docker

  # Secrets genereren en .env aanmaken
  - bash /opt/supabase/generate-env.sh

  # Supabase starten
  - [bash, -c, "cd /opt/supabase/docker && docker compose pull && docker compose up -d"]

  # Opslag voor admin user
  - mkdir -p /opt/docker/compose /opt/docker/data
  - chown -R admin:admin /opt/docker

  # Docker prune cronjob (skip supabase images)
  - echo "0 3 * * 0 root docker image prune -af --filter 'label!=com.supabase' 2>&1 | logger -t docker-prune" > /etc/cron.d/docker-prune

  # Bewaar credentials op leesbare plek
  - |
    echo "" >> /etc/motd
    echo "=== Supabase ===" >> /etc/motd
    echo "Studio:  http://$(hostname -I | awk '{print $1}'):3000" >> /etc/motd
    echo "API:     http://$(hostname -I | awk '{print $1}'):8000" >> /etc/motd
    echo "Config:  /opt/supabase/docker/.env" >> /etc/motd
    echo "" >> /etc/motd

final_message: "Supabase setup voltooid na $UPTIME seconden - Studio op http://<IP>:3000, API op http://<IP>:8000"
